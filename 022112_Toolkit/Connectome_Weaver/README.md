---
muid: fe91ce22-8e13-4114-96b2-128b7db64e98
---
# Connectome Weaver (`weaverSG`)

### 1. Краткое описание

`weaverSG` — это транзакционный CLI-инструмент для полного жизненного цикла Семантических Графов (SG) в экосистеме EnMaTeS: аудита, миграции схемы, безопасного редактирования и управления логами.

### 2. Предназначение и роль в экосистеме

В парадигме метасистемы **Membra**, Семантический Граф (SG) является **артефактом** — статичной "картой" или снимком **Коннектома** (полной структуры связей ИИ-существа). `Connectome Weaver` и его ядро `weaverSG` — это **система**, которая выступает в роли "Картографа", обеспечивая целостность, прослеживаемость и эволюцию этой карты.

Ключевые задачи, которые решает `weaverSG`:

* **Целостность данных:** Инструмент позволяет проводить полный аудит графа, находить "висячие" связи, дубликаты и другие аномалии.
* **Безопасные изменения:** Все модификации выполняются через транзакционный механизм с ведением лога (`LSG`) и автоматическим созданием бэкапов. Это гарантирует, что граф никогда не будет поврежден в результате сбоя.
* **Прослеживаемость (Traceability):** Каждое изменение в SG фиксируется в связанном с ним Log Semantic Graph (`LSG`). Это позволяет отследить полную историю каждого узла и каждой связи.
* **Эволюция структуры:** `weaverSG` предоставляет механизмы для безопасной миграции схемы графа, например, для "продвижения" легковесных связей (`link` — устанавливается между "артефактами") до системных связок (`bind` — устанавливается между "системами").
* **Управление логами:** Инструмент позволяет архивировать, встраивать (`bundle`) и извлекать (`detach`) логи изменений для удобства хранения и переноса.

### 3. Установка

1.  Убедитесь, что у вас установлен Python 3.
2.  Установите необходимые зависимости:
    ```bash
    pip install pyyaml
    ```

### 4. Список Команд

Все команды выполняются из корневой папки проекта.

* **`validate`**: Выполняет полный аудит Семантического Графа для проверки его целостности.
    ```bash
    python weaverSG/main.py validate --file path/to/MyGraph.md [--output-format human|json]
    ```

* **`batch-modify`**: Применяет серию операций к графу на основе инструкций из YAML-файла "рецепта".
    ```bash
    python weaverSG/main.py batch-modify --recipe path/to/recipe.yaml --file path/to/MyGraph.md
    ```

* **`promote-relation`**: Повышает "легковесную" связь типа `link` до "системной" связи типа `bind`.
    ```bash
    python weaverSG/main.py promote-relation --lid <LID_связи> --file path/to/MyGraph.md
    ```

* **`archive-log`**: Архивирует текущий файл лога (LSG), сохраняя непрерывность истории.
    ```bash
    python weaverSG/main.py archive-log --file path/to/MyGraph.md
    ```

* **`bundle-log`**: Встраивает внешний файл лога (LSG) в основной файл графа (SG).
    ```bash
    python weaverSG/main.py bundle-log --file path/to/MyGraph.md
    ```

* **`detach-log`**: Извлекает встроенный лог из графа (SG) в отдельный файл (LSG).
    ```bash
    python weaverSG/main.py detach-log --file path/to/MyGraph.md
    ```

* **`cleanup-backups`**: Находит и удаляет все файлы резервных копий (`*_backup_*.md`).
    ```bash
    python weaverSG/main.py cleanup-backups --file path/to/MyGraph.md [--yes]
    ```

### 5. Ключевые концепции и нюансы

* **Транзакционность и логирование (LSG):** Ядро "Ткача" — `lsg_manager`. Он гарантирует, что любая операция (даже из рецепта) сначала выполняется в памяти. Если все успешно, создается бэкап, изменения сохраняются в основной граф (SG), а в лог-граф (LSG) добавляется транзакционная запись. Это обеспечивает полную атомарность и безопасность.

* **Непрерывность истории (Архивация):** Команда `archive-log` не просто переименовывает старый лог. Она создает новый, пустой LSG и добавляет в него **первую транзакцию-ссылку ("breadcrumb")**, которая указывает на имя архивного файла. Это гарантирует, что даже при разделении логов на части, цепочка истории никогда не прерывается.

* **Режимы валидации:** Команда `validate` имеет два режима работы:
    1.  **Быстрая проверка:** Если запустить команду с флагом `--output-format json`, то `weaverSG` просто выведет JSON-отчет в консоль и **не будет изменять файлы и создавать лог**. Это идеально для быстрой диагностики в CI/CD.
    2.  **Обновление файла и лога (режим по умолчанию):** Если запустить команду без флага `--output-format json` (т.е., в режиме вывода по умолчанию `human`), то `weaverSG` сравнивает найденные проблемы с теми, что уже записаны в файле графа. Если набор проблем изменился (найдены новые проблемы или старые были исправлены), инструмент обновит блок `validation_issues` в файле графа, запишет операцию обновления в лог изменений (LSG) и сохранит оба файла (SG и LSG). Если же набор проблем остался прежним, файлы не будут изменены.

### 6. Операции в рецептах (для `batch-modify`)

Команда `batch-modify` выполняет последовательность операций, описанных в YAML-файле рецепта. Ниже представлен список операций, которые могут быть использованы в поле `operations` рецепта:

* `add_node`: Добавляет новый узел.
* `update_node`: Обновляет поля существующего узла по его `MUID`.
* `delete_node`: Удаляет узел по его `MUID`.
* `add_or_update_node`: Добавляет узел, если его нет, или обновляет, если он уже существует.
* `add_relation`: Добавляет новую связь.
* `update_relation`: Обновляет поля существующей связи по ее `LID`.
* `update_relations_by_query`: Находит все связи, соответствующие запросу, и обновляет их.
* `update_graph_properties`: Обновляет свойства верхнего уровня самого графа (например, `validation_issues`).
* `add_node_field`: Добавляет новое поле ко всем узлам в графе.
* `copy_field`: Копирует значение из одного поля в другое для указанных сущностей.
* `set_field_from_generated_uuid`: Генерирует и устанавливает новый UUID в указанное поле.
* `add_lid_to_all_links` (или `add_lid_to_links`): Генерирует `LID` для всех связей класса `link`, у которых его нет.
* `update_relation_endpoints_after_muid_change`: Обновляет `from_MUID` и `to_MUID` в связях после миграции `MUID` узлов.

### 7. Пример рабочего процесса: Первичная миграция графа

Для первоначальной настройки и исправления существующего Семантического Графа мы используем следующий рабочий процесс: **"Диагностика -> Исправление -> Миграция"**.

1.  **Диагностика (`validate`):**
    Запускаем аудит на исходном графе, чтобы получить полный список проблем.
    ```bash
    python weaverSG/main.py validate --file path/to/MyOriginalGraph.md
    ```

2.  **Исправление данных (`recipe_datafix...`):**
    Запускаем рецепт, который исправляет логические ошибки в данных (например, "висячие" связи).
    ```bash
    python weaverSG/main.py batch-modify --recipe recipes/recipe_datafix_v3_dangling_nodes.yaml --file path/to/MyOriginalGraph.md
    ```

3.  **Миграция схемы (`recipe_schema...`):**
    Запускаем рецепт, который проводит глобальную миграцию схемы: вводит поле `alias`, заменяет все текстовые `MUID` на каноничные `UUID` и т.д.
    ```bash
    python weaverSG/main.py batch-modify --recipe recipes/recipe_schema_v3_muid_alias.yaml --file path/to/MyOriginalGraph.md
    ```

### 8. Лицензия

Membra Open Development License (MODL) v1.0
Copyright (c) Rustam Kunafin 2025. All rights reserved.

Licensed under Membra Open Development License (MODL) v1.0. See LICENSE or https://cyberries.org/04_Resources/0440_Agreements/MODL.
Core artifacts are under MODL; derivatives may use other licenses with attribution.