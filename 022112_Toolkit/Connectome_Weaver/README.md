---
muid: fe91ce22-8e13-4114-96b2-128b7db64e98
---
# Connectome Weaver (`weaverSG`)

### 1. Краткое описание

`weaverSG` — это транзакционный CLI-инструмент для полного жизненного цикла Семантических Графов (SG) в экосистеме EnMaTeS: аудита, миграции схемы, безопасного редактирования и управления логами.

### 2. Предназначение и роль в экосистеме

В парадигме метасистемы **Membra**, Семантический Граф (SG) является **артефактом** — статичной "картой" или снимком **Коннектома** (полной структуры связей ИИ-существа). `Connectome Weaver` и его ядро `weaverSG` — это **система**, которая выступает в роли "Картографа", обеспечивая целостность, прослеживаемость и эволюцию этой карты.

Ключевые задачи, которые решает `weaverSG`:

* **Целостность данных:** Инструмент позволяет проводить полный аудит графа, находить "висячие" связи, дубликаты и другие аномалии.
* **Безопасные изменения:** Все модификации выполняются через транзакционный механизм с ведением лога (`LSG`) и автоматическим созданием бэкапов. Это гарантирует, что граф никогда не будет поврежден в результате сбоя.
* **Прослеживаемость (Traceability):** Каждое изменение в SG фиксируется в связанном с ним Log Semantic Graph (`LSG`). Это позволяет отследить полную историю каждого узла и каждой связи.
* **Эволюция структуры:** `weaverSG` предоставляет механизмы для безопасной миграции схемы графа, например, для "продвижения" легковесных связей (`link`) до системных связок (`bind`).
* **Управление логами:** Инструмент позволяет архивировать, встраивать (`bundle`) и извлекать (`detach`) логи изменений для удобства хранения и переноса.

### 3. Установка

1.  Убедитесь, что у вас установлен Python 3.
2.  Установите необходимые зависимости:

```bash 
pip install pyyaml
```

### 4. Использование

Все команды выполняются из корневой папки проекта.

#### **Основные Команды**

Выполняет полный аудит графа, выводит отчет в консоль и записывает найденные проблемы в блок `validation_issues` в самом файле графа.

```bash 
python weaverSG/main.py validate --file path/to/MyGraph.md
```

#### Пакетное изменение графа (Лечение)

Выполняет серию операций, описанных в файле-рецепте.

```bash 
python weaverSG/main.py batch-modify --recipe path/to/recipe.yaml --file path/to/MyGraph.md
```

*   `--recipe`: Путь к YAML-файлу с инструкциями.
*   `--file`: Путь к целевому файлу Семантического Графа.
*   `--no-backup` (опционально): Отключает автоматическое создание бэкапа.

#### Продвижение связи

Превращает легковую связь `link` (идентифицируемую по `LID`) в системную `bind`, присваивая ей `MUID`.

```bash 
python weaverSG/main.py promote-relation --lid <LID_связи> --file path/to/MyGraph.md
```

### 4.1. Все доступные команды

Ниже представлен полный список команд, доступных в инструменте `weaverSG`:

*   **validate**: Выполняет полный аудит Семантического Графа для проверки его целостности. Находит и сообщает о дубликатах узлов и связей, висячих связях и других аномалиях.

```bash 
python weaverSG/main.py validate --file path/to/MyGraph.md [--output-format human|json]
```

*   `--file`: Путь к файлу Семантического Графа.
    *   `--output-format` (опционально): Формат вывода отчета ('human' для чтения человеком, 'json' для машинной обработки).

*   **batch-modify**: Позволяет применить серию операций к Семантическому Графу на основе инструкций, описанных в YAML-файле рецепта. Идеально подходит для пакетного исправления данных или миграции схемы.

```bash 
python weaverSG/main.py batch-modify --recipe path/to/recipe.yaml --file path/to/MyGraph.md
```

*   `--recipe`: Путь к YAML-файлу с описанием операций (рецепту).
    *   `--file`: Путь к целевому файлу Семантического Графа.

*   **promote-relation**: Повышает "легковесную" связь типа `link` до "системной" связи типа `bind`. При этом связи присваивается уникальный MUID, а оригинальный LID сохраняется как `legacy_LID` для прослеживаемости.

```bash 
python weaverSG/main.py promote-relation --lid <LID_связи> --file path/to/MyGraph.md
```

*   `--lid`: LID (Link ID) связи типа `link`, которую необходимо повысить.
    *   `--file`: Путь к целевому файлу Семантического Графа.

*   **archive-log**: Архивирует текущий файл Log Semantic Graph (LSG), переименовывая его с добавлением временной метки. Создает новый пустой LSG-файл и добавляет в него запись, указывающую на заархивированный лог, сохраняя историю изменений.

```bash 
python weaverSG/main.py archive-log --file path/to/MyGraph.md
```

*   `--file`: Путь к основному файлу Семантического Графа (LSG-файл должен находиться в той же директории и иметь имя LSG_<имя_файла_SG>.md).

*   **bundle-log**: Перемещает содержимое внешнего файла LSG в основной файл SG, сохраняя его в поле `log_history`. После успешного выполнения внешний файл LSG удаляется.

```bash 
python weaverSG/main.py bundle-log --file path/to/MyGraph.md
```

*   `--file`: Путь к основному файлу Семантического Графа.

*   **detach-log**: Извлекает лог-историю из поля `log_history` основного файла SG и сохраняет её как отдельный внешний файл LSG (с именем LSG_<имя_файла_SG>.md) в той же директории.

```bash 
python weaverSG/main.py detach-log --file path/to/MyGraph.md
```

*   `--file`: Путь к основному файлу Семантического Графа.

*   **cleanup-backups**: Находит и удаляет все файлы резервных копий (`*_backup_*.md`) в директории указанного файла SG. Может работать в интерактивном режиме (с запросом подтверждения) или неинтерактивном (с флагом `--yes`).

```bash 
python weaverSG/main.py cleanup-backups --file path/to/MyGraph.md [--yes]
```

*   `--file`: Путь к основному файлу Семантического Графа (используется для определения директории поиска резервных копий).
    *   `--yes` (опционально): Пропустить запрос интерактивного подтверждения.

### 4.2. Операции в рецептах (для `batch-modify`)

Команда `batch-modify` выполняет последовательность операций, описанных в YAML-файле рецепта. Ниже представлен список операций, которые могут быть использованы в поле `operations` рецепта, с кратким описанием:

*   **add_node**: Добавляет новый узел в граф. Требует `node_data` с обязательным полем `MUID`.
*   **update_node**: Обновляет поля существующего узла, идентифицируемого по `muid`. Требует `muid` и `updates` (словарь с полями для обновления).
*   **delete_node**: Удаляет узел из графа по его `muid`. Требует `muid`.
*   **add_or_update_node**: Проверяет наличие узла с заданным `MUID`. Если узел существует, обновляет его; если нет, добавляет новый. Требует `node_data` с обязательным полем `MUID`.
*   **add_relation**: Добавляет новую связь в граф. Требует `relation_data` (словарь, описывающий связь).
*   **update_relation**: Обновляет поля существующей связи, идентифицируемой по `lid`. Требует `lid` и `updates` (словарь с полями для обновления).
*   **update_relations_by_query**: Находит все связи, которые соответствуют заданному словарю `query`, и применяет к ним изменения, описанные в словаре `updates`. Требует `query` и `updates`.
*   **update_graph_properties**: Обновляет свойства верхнего уровня самого графа (например, добавляет или изменяет поле `validation_issues`). Требует `updates`.
*   **add_node_field**: Добавляет новое поле (`field_name`) ко всем узлам в графе. Можно указать `default_value`.
*   **copy_field**: Копирует значение из `source_field` в `target_field` для сущностей (узлов или связей) типа `entity_type`, которые соответствуют условию в `where`.
*   **set_field_from_generated_uuid**: Генерирует новый UUID и устанавливает его в `target_field` для сущностей типа `entity_type`, которые соответствуют условию в `where`.
*   **add_lid_to_all_links** (alias: `add_lid_to_links`): Проходит по всем связям класса `link` и генерирует уникальный `LID` для тех, у кого его нет.
*   **update_relation_endpoints_after_muid_change**: Обновляет `from_MUID` и `to_MUID` связей, если соответствующие узлы изменили свои MUID в ходе миграции (предполагается, что старый MUID сохранен в поле `alias`).

### 5. Пример рабочего процесса: Первичная миграция графа

Для первоначальной настройки и исправления существующего Семантического Графа мы используем следующий рабочий процесс: **"Диагностика -> Исправление -> Миграция"**.

1.  **Диагностика (`validate`):**
    Сначала запускаем аудит на исходном, нетронутом графе, чтобы получить полный список проблем.
    ```bash
    python 022112_Toolkit/Connectome_Weaver/weaverSG/main.py validate --file path/to/MyOriginalGraph.md
    ```

2.  **Исправление данных (`recipe_datafix...`):**
    После анализа отчета о валидации, мы запускаем рецепт, который исправляет логические ошибки в данных (например, "висячие" связи).
    ```bash
    python 022112_Toolkit/Connectome_Weaver/weaverSG/main.py batch-modify --recipe recipes/recipe_datafix_v2.yaml --file path/to/MyOriginalGraph.md
    ```

3.  **Миграция схемы (`recipe_schema...`):**
    После исправления данных, этот рецепт проводит глобальную миграцию схемы: вводит поле `alias`, заменяет все текстовые `MUID` на каноничные `UUID` и присваивает `LID` всем старым связям.
    ```bash
    python 022112_Toolkit/Connectome_Weaver/weaverSG/main.py batch-modify --recipe recipes/recipe_schema_v2_muid_alias_lid.yaml --file path/to/MyOriginalGraph.md
    ```

### 6. Лицензия

Membra Open Development License (MODL) v1.0
Copyright (c) Rustam Kunafin 2025. All rights reserved.

Licensed under Membra Open Development License (MODL) v1.0. See LICENSE or https://cyberries.org/04_Resources/0440_Agreements/MODL.
Core artifacts are under MODL; derivatives may use other licenses with attribution.